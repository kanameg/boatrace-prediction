## 番組表データ変換プログラム仕様書

### 目的
ボートレースの公式サイトが提供する番組表データを読み込み、CSV形式の番組表データに変換するためのプログラムの仕様を定義します。

#### プログラミング言語
Python 3.10
#### ファイル名
`convert_program.py`

#### 実行方法
```bash
python convert_program.py 2025 7 9
```
### 引数
- 年: 4桁の年（例: 2025）
- 月: 1桁または2桁の月（例: 7） 0埋め許可
- 日: 1桁または2桁の日（例: 9） 0埋め許可

### 概要
引数で指定された年月日の番組表データを読み込み、プレーンテキスト形式の番組表データから必要な情報を抽出し、CSV形式の番組表データに変換します。CSV形式のデータは、すでに存在する番組表データファイルに追記して出力します。

### 入力データ
- ファイル名: `b{年}{月:02d}{日:02d}_u8.txt`
- ディレクトリ: `data/raw/programs/`

ボートレースの公式サイトから取得した番組表データをUTF-8に変換したファイル。以下のような形式で提供されます。
- サンプルファイル `data/raw/programs/b240101_u8.txt`

各レースの情報は以下のような形式で記載されています。

```plaintext
ボートレース大　村   　１月　１日  ミッドナイトボートレ  第　１日

                            ＊＊＊　番組表　＊＊＊

          ミッドナイトボートレース１０ＴＨｉｎ大村　　　　　

   第　１日          ２０２４年　１月　１日                  ボートレース大　村

               −内容については主催者発行のものと照合して下さい−


　１Ｒ  予選　　　　          Ｈ１８００ｍ  電話投票締切予定１７：４１ 
-------------------------------------------------------------------------------
艇 選手 選手  年 支 体級    全国      当地     モーター   ボート   今節成績  早
番 登番  名   齢 部 重別 勝率  2率  勝率  2率  NO  2率  NO  2率  １２３４５６見
-------------------------------------------------------------------------------
1 3501川上昇平54長崎55B1 4.92 25.30 5.38 33.85 50 30.22 12 36.62              8
2 5129山口真喜26長崎46B1 4.78 31.18 4.29 19.47 46 23.70 61 27.27              9
3 4299中島浩哉41長崎56B1 4.50 25.64 4.91 24.82 59 28.57 49 27.91               
4 4855江頭賢太27長崎54B2 3.80 17.50 3.86 19.57 18 36.30 67 30.88               
5 4393田中孝明37福岡58B2 3.05  3.33 4.65 16.13 31 22.96 45 40.91               
6 3773津留浩一49長崎55B1 4.85 30.59 5.04 31.31 57 25.58 25 37.04              7

　２Ｒ  予選　　　　          Ｈ１８００ｍ  電話投票締切予定１８：０８ 
-------------------------------------------------------------------------------
艇 選手 選手  年 支 体級    全国      当地     モーター   ボート   今節成績  早
番 登番  名   齢 部 重別 勝率  2率  勝率  2率  NO  2率  NO  2率  １２３４５６見
-------------------------------------------------------------------------------
1 4315山崎昂介39長崎53B1 4.92 29.29 5.85 38.71 74 45.59 22 29.37              8
2 4603谷川将太35長崎53B1 4.66 25.81 5.15 33.10 26 25.19 57 27.50              7
3 5048眞鳥康太29長崎56B1 5.05 31.76 4.63 23.14 28 31.39 58 33.10             11
4 5219森口和紀23福岡53B1 3.78 18.68 2.27  6.06 66 31.34 54 34.15               
5 4241大串重幸38長崎52B1 4.78 23.46 5.20 32.77 72 24.39 32 30.00             10
6 4705吉川勇作35長崎54B1 4.15 23.53 4.39 25.49 70 36.36 41 36.17              6
```


### 出力データ
変換後のCSV形式のレース結果データを出力する。

- ファイル名: `race_programs.csv`
- ディレクトリ: `data/`
- csv形式の項目 カラム定義は以下の通りです。
```CSV
年,月,日,レース場番号,レース番号,距離(m),投票締切時間,\
1艇_選手登番,1艇_年齢,1艇_支部,1艇_体重,1艇_級別,1艇_全国勝率,1艇_全国2連率,1艇_当地勝率,1艇_当地2連率,1艇_モーター番号,1艇_モーター2連率,1艇_ボート番号,1艇_ボート2連率,\
2艇_選手登番,2艇_年齢,2艇_支部,2艇_体重,2艇_級別,2艇_全国勝率,2艇_全国2連率,2艇_当地勝率,2艇_当地2連率,2艇_モーター番号,2艇_モーター2連率,2艇_ボート番号,2艇_ボート2連率,\
3艇_選手登番,3艇_年齢,3艇_支部,3艇_体重,3艇_級別,3艇_全国勝率,3艇_全国2連率,3艇_当地勝率,3艇_当地2連率,3艇_モーター番号,3艇_モーター2連率,3艇_ボート番号,3艇_ボート2連率,\
4艇_選手登番,4艇_年齢,4艇_支部,4艇_体重,4艇_級別,4艇_全国勝率,4艇_全国2連率,4艇_当地勝率,4艇_当地2連率,4艇_モーター番号,4艇_モーター2連率,4艇_ボート番号,4艇_ボート2連率,\
5艇_選手登番,5艇_年齢,5艇_支部,5艇_体重,5艇_級別,5艇_全国勝率,5艇_全国2連率,5艇_当地勝率,5艇_当地2連率,5艇_モーター番号,5艇_モーター2連率,5艇_ボート番号,5艇_ボート2連率,\
6艇_選手登番,6艇_年齢,6艇_支部,6艇_体重,6艇_級別,6艇_全国勝率,6艇_全国2連率,6艇_当地勝率,6艇_当地2連率,6艇_モーター番号,6艇_モーター2連率,6艇_ボート番号,6艇_ボート2連率
```

### レース場番号の定義
レース場番号は以下のように定義されます。
#### レース場番号
|番号|レース場名|
|----|----------|
| 01 | 桐生     |
| 02 | 戸田     |
| 03 | 江戸川   |
| 04 | 平和島   |
| 05 | 多摩川   |
| 06 | 浜名湖   |
| 07 | 蒲郡     |
| 08 | 常滑     |
| 09 | 津       |
| 10 | 三国     |
| 11 | びわこ   |
| 12 | 住之江   |
| 13 | 尼崎     |
| 14 | 鳴門     |
| 15 | 丸亀     |
| 16 | 児島     |
| 17 | 宮島     |
| 18 | 徳山     |
| 19 | 下関     |
| 20 | 若松     |
| 21 | 芦屋     |
| 22 | 福岡     |
| 23 | 唐津     |
| 24 | 大村     |

### 着順の定義
着順は以下のように定義されます。
| 着順 | 定義                       |
|------|----------------------------|
|  01  | 1着                        |
|  02  | 2着                        |
|  03  | 3着                        |
|  04  | 4着                        |
|  05  | 5着                        |
|  06  | 6着                        |
|  S0  | 失格(選手責任外)           |
|  S1  | 失格(選手責任)             |
|  S2  | 失格(選手責任・他艇を妨害) |
|   F  | フライング                 |
|  L0  |  出遅れ (選手責任外)       |
|  L1  |  出遅れ (選手責任)         |
|  K0  | 欠場 (選手責任外)          |
|  K1  | 欠場 (選手責任)            |

### スタートタイミングの定義
スタートタイミングは艇がフライングの場合は時間の前に`F`がついている。これはマイナスのタイミングでスタートしたことを示すので、`-`に変換する。

### 処理の流れ
1. **引数チェック**
   - 引数の数が3個（年月日）であることを確認
   - 不足している場合は使用方法を表示して終了

2. **引数の妥当性検証**
   - 年: 1900〜2100の範囲の数値であることを確認
   - 月: 1〜12の範囲の数値であることを確認
   - 日: 1〜31の範囲の数値であることを確認
   - 無効な値の場合はエラーメッセージを表示して終了

3. **ファイルパスの生成**
   - 入力ファイル: `data/raw/programs/b{年下2桁}{月:02d}{日:02d}_u8.txt`
   - 出力ファイル: `data/race_programs.csv`

4. **入力ファイルの存在確認**
   - ファイルが存在しない場合はエラーメッセージを表示して終了

5. **入力ファイルの読み込み**
   - UTF-8エンコーディングでファイルを読み込み
   - 全行をメモリに読み込み

6. **データ解析ループ**
   - 行ごとに以下の処理を実行：
     - トラック開始マーカー（`{番号}BBGN`）の検出
     - レース場名からトラック番号の抽出
     - トラック終了マーカー（`{番号}BEND`）の検出
     - レースヘッダー（`{番号}Ｒ` + `電話投票締切予定`）の検出
     - レース区間の処理（レース情報と6艇のデータを抽出）

7. **レース区間の詳細処理**
   - レースヘッダー情報の解析（レース番号、距離、投票締切時間）
   - 艇データの解析（選手情報、モーター・ボート情報、成績データ）
   - 6艇すべてのデータが揃った場合のみレースデータとして採用

8. **CSV出力**
   - 出力ファイルの存在確認（新規作成時はヘッダー行を追加）
   - 各レースについて1行のCSVデータを生成
   - 6艇分のデータを固定順序で出力（データがない場合は空文字）
   - ファイルに追記モードで出力

9. **処理結果の表示**
   - 変換されたレース数を表示
   - 出力ファイルパスを表示
   - 正常終了（終了コード0）またはエラー終了（終了コード1）



## 範囲指定番組表データ変換スクリプト仕様書

### 目的
指定された期間の番組表データを一括で変換するためのスクリプトの仕様を定義します。

#### プログラミング言語
bashスクリプト

#### ファイル名
`convert_programs_range.sh`

#### 実行方法
```bash
./convert_programs_range.sh START_YYYY START_MM START_DD END_YYYY END_MM END_DD
```
### 引数
- 開始年: 4桁の年（例: 2025）
- 開始月: 1桁または2桁の月（例: 7） 0埋め許可
- 開始日: 1桁または2桁の日（例: 9） 0埋め許可
- 終了年: 4桁の年（例: 2025）
- 終了月: 1桁または2桁の月（例: 7） 0埋め許可
- 終了日: 1桁または2桁の日（例: 9） 0埋め許可

### 概要
指定された期間の番組表データを一括で変換します。期間は開始日と終了日で指定します。期間内の各日の番組表データを`convert_program.py`スクリプトを使用して変換します。
### 入力データ
- ディレクトリ: `data/raw/programs/`
- ファイル名: `b{年}{月:02d}{日:02d}_u8.txt`
### 出力データ
- ディレクトリ: `data/`
- ファイル名: `race_programs.csv`

### エラーハンドリング
- 引数が不足している場合、エラーメッセージを表示して終了します。
- 引数に無効な値が含まれている場合、エラーメッセージを表示して終了します。
- 開始日が終了日より後の場合、エラーメッセージを表示して終了します。
- 各日付のダウンロードに失敗した場合、エラーメッセージを表示して終了します。

### 処理の流れ
1. **引数チェック**
   - 引数の数が6個であることを確認
   - 不足している場合は使用方法を表示して終了

2. **引数の妥当性検証**
   - 開始年・終了年: 4桁の数値であることを確認
   - 開始月・終了月: 1〜12の範囲の数値であることを確認
   - 開始日・終了日: 1〜31の範囲の数値であることを確認
   - 無効な値の場合はエラーメッセージを表示して終了

3. **日付の前後関係チェック**
   - 開始日と終了日をエポック秒に変換
   - 開始日が終了日より後の場合はエラーメッセージを表示して終了

4. **convert_program.pyの存在確認**
   - 同じディレクトリにファイルが存在することを確認
   - 存在しない場合はエラーメッセージを表示して終了

5. **処理対象日数の計算と表示**
   - 期間内の総日数を計算
   - 処理開始メッセージと期間、日数を表示

6. **各日付の順次処理**
   - 開始日から終了日まで1日ずつループ処理
   - 各日について以下を実行：
     - エポック秒を年月日に変換
     - 進捗表示（[現在日/総日数] 年月日の処理中...）
     - `python3 convert_program.py 年 月 日`を実行
     - 成功時：成功カウンターを増加
     - 失敗時：エラーメッセージを表示してスクリプト終了

7. **処理結果の集計と表示**
   - 成功日数、エラー日数、合計日数を表示
   - エラーがあった場合は警告メッセージと共に終了コード1で終了
   - 全て成功した場合は完了メッセージと出力ファイルパスを表示して終了コード0で終了
